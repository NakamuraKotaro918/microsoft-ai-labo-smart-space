name: Create Azure Static Web App

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: 'ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å'
        required: true
        default: 'smart-space-rg'
      static_web_app_name:
        description: 'Static Web Appå'
        required: true
        default: 'smart-space-dashboard'
      location:
        description: 'ãƒªãƒ¼ã‚¸ãƒ§ãƒ³'
        required: true
        default: 'japaneast'
      github_repo:
        description: 'GitHubãƒªãƒã‚¸ãƒˆãƒª (owner/repo)'
        required: true
        default: 'kyokko-electric/microsoft-ai-labo-smart-space'
      branch:
        description: 'ãƒ–ãƒ©ãƒ³ãƒå'
        required: true
        default: 'azure-deployment'
      app_location:
        description: 'ã‚¢ãƒ—ãƒªã®å ´æ‰€'
        required: true
        default: 'dashboard'

jobs:
  create_static_webapp:
    runs-on: ubuntu-latest
    name: Create Azure Static Web App
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Create Resource Group
        run: |
          echo "ðŸ“¦ ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆä¸­..."
          az group create \
            --name ${{ github.event.inputs.resource_group }} \
            --location ${{ github.event.inputs.location }} \
            --output table
          echo "âœ… ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
      
      - name: Create Static Web App
        run: |
          echo "ðŸŒ Static Web App ã‚’ä½œæˆä¸­..."
          az staticwebapp create \
            --name ${{ github.event.inputs.static_web_app_name }} \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --source https://github.com/${{ github.event.inputs.github_repo }} \
            --branch ${{ github.event.inputs.branch }} \
            --app-location ${{ github.event.inputs.app_location }} \
            --output table
          echo "âœ… Static Web App ãŒä½œæˆã•ã‚Œã¾ã—ãŸ"
      
      - name: Get Deployment Token
        id: get-token
        run: |
          echo "ðŸ”‘ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ä¸­..."
          TOKEN=$(az staticwebapp secrets set \
            --name ${{ github.event.inputs.static_web_app_name }} \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --secret-name deployment-token \
            --secret-value "auto-generated" \
            --query properties.secretValue \
            --output tsv)
          echo "::set-output name=deployment_token::$TOKEN"
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
      
      - name: Get App URL
        id: get-url
        run: |
          echo "ðŸ”— ã‚¢ãƒ—ãƒªURLã‚’å–å¾—ä¸­..."
          URL=$(az staticwebapp show \
            --name ${{ github.event.inputs.static_web_app_name }} \
            --resource-group ${{ github.event.inputs.resource_group }} \
            --query defaultHostname \
            --output tsv)
          echo "::set-output name=app_url::https://$URL"
          echo "âœ… ã‚¢ãƒ—ãƒªURL: https://$URL"
      
      - name: Create Summary
        run: |
          echo "## ðŸŽ‰ Azure Static Web App ä½œæˆå®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä½œæˆã•ã‚ŒãŸãƒªã‚½ãƒ¼ã‚¹" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—**: ${{ github.event.inputs.resource_group }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Static Web App**: ${{ github.event.inputs.static_web_app_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: ${{ github.event.inputs.location }}" >> $GITHUB_STEP_SUMMARY
          echo "- **GitHubãƒªãƒã‚¸ãƒˆãƒª**: ${{ github.event.inputs.github_repo }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ–ãƒ©ãƒ³ãƒ**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±" >> $GITHUB_STEP_SUMMARY
          echo "- **ã‚¢ãƒ—ãƒªURL**: ${{ steps.get-url.outputs.app_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³**: ç”Ÿæˆæ¸ˆã¿ï¼ˆAzure Portalã§ç¢ºèªå¯èƒ½ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“š æ¬¡ã®æ‰‹é †" >> $GITHUB_STEP_SUMMARY
          echo "1. Azure Portal ã§ Static Web App ãƒªã‚½ãƒ¼ã‚¹ã«ç§»å‹•" >> $GITHUB_STEP_SUMMARY
          echo "2. 'ç®¡ç†' ã‚¿ãƒ–ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèª" >> $GITHUB_STEP_SUMMARY
          echo "3. GitHub ãƒªãƒã‚¸ãƒˆãƒªã® Settings > Secrets ã§ä»¥ä¸‹ã‚’è¨­å®šï¼š" >> $GITHUB_STEP_SUMMARY
          echo "   - `AZURE_STATIC_WEB_APPS_API_TOKEN`: [ãƒ‡ãƒ—ãƒ­ã‚¤ãƒˆãƒ¼ã‚¯ãƒ³]" >> $GITHUB_STEP_SUMMARY
          echo "4. ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹" >> $GITHUB_STEP_SUMMARY
